#!/usr/bin/env bash
# This script was generated by bashly 1.2.9 (https://bashly.dev)
# Modifying it manually is not recommended

# :wrapper.bash3_bouncer
if [[ "${BASH_VERSINFO:-0}" -lt 4 ]]; then
  printf "bash version 4 or higher is required\n" >&2
  exit 1
fi

# :command.master_script

# :command.version_command
version_command() {
  echo "$version"
}

# :command.usage
barekube_usage() {
  printf "barekube - CLI that provides functionality for installing and configuring bare kubernetes based on k3s and gVisor.\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube COMMAND\n"
  printf "  barekube [COMMAND] --help | -h\n"
  printf "  barekube --version | -v\n"
  echo
  # :command.usage_commands
  printf "%s\n" "$(bold "Commands:")"
  printf "  %s   Install and configure barekube and dependencies\n" "$(green "install")                      "
  [[ -n "$long_usage" ]] && printf "  %s   Install and configure barekube dependencies\n" "$(green "install dependencies")         "
  [[ -n "$long_usage" ]] && printf "  %s   Install and configure barekube kubernetes distribution (k3s)\n" "$(green "install initial-master")       "
  [[ -n "$long_usage" ]] && printf "  %s   Install and configure another k3s master node\n" "$(green "install master-node")          "
  [[ -n "$long_usage" ]] && printf "  %s   Install and configure k3s agent node\n" "$(green "install agent-node")           "
  [[ -n "$long_usage" ]] && printf "  %s   Install and configure gVisor for existing k3s node\n" "$(green "install gvisor")               "
  [[ -n "$long_usage" ]] && printf "  %s   Install and configure Longhorn storage dependencies\n" "$(green "install longhorn-dependencies")"
  printf "  %s   \n" "$(green "k3s")                          "
  [[ -n "$long_usage" ]] && printf "  %s   Start k3s master node\n" "$(green "k3s start")                    "
  [[ -n "$long_usage" ]] && printf "  %s   Stop k3s master node\n" "$(green "k3s stop")                     "
  [[ -n "$long_usage" ]] && printf "  %s   Uninstall k3s and all related containers\n" "$(green "k3s uninstall")                "
  [[ -n "$long_usage" ]] && printf "  %s   Kill k3s and all k3s related containers\n" "$(green "k3s killall")                  "
  [[ -n "$long_usage" ]] && printf "  %s   Start k3s agent node\n" "$(green "k3s start-agent")              "
  [[ -n "$long_usage" ]] && printf "  %s   Stop k3s agent node\n" "$(green "k3s stop-agent")               "
  printf "  %s   Upgrade barekube CLI to latest version\n" "$(green "upgrade")                      "
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo
    printf "  %s\n" "$(magenta "--version, -v")"
    printf "    Show version number\n"
    echo

    # :command.footer
    printf "MIT License: https://github.com/kostiantyn-matsebora/barekube/blob/master/LICENSE\nCopyright (c) 2025 Kostiantyn Matsebora\n"
    echo

  fi
}

# :command.usage
barekube_install_usage() {
  printf "barekube install - Install and configure barekube and dependencies\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube install COMMAND\n"
  printf "  barekube install [COMMAND] --help | -h\n"
  echo
  # :command.usage_commands
  printf "%s\n" "$(bold "Commands:")"
  printf "  %s   Install and configure barekube dependencies\n" "$(green "dependencies")         "
  printf "  %s   Install and configure barekube kubernetes distribution (k3s)\n" "$(green "initial-master")       "
  printf "  %s   Install and configure another k3s master node\n" "$(green "master-node")          "
  printf "  %s   Install and configure k3s agent node\n" "$(green "agent-node")           "
  printf "  %s   Install and configure gVisor for existing k3s node\n" "$(green "gvisor")               "
  printf "  %s   Install and configure Longhorn storage dependencies\n" "$(green "longhorn-dependencies")"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_install_dependencies_usage() {
  printf "barekube install dependencies - Install and configure barekube dependencies\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube install dependencies\n"
  printf "  barekube install dependencies --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_install_initial_master_usage() {
  printf "barekube install initial-master - Install and configure barekube kubernetes distribution (k3s)\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube install initial-master [OPTIONS]\n"
  printf "  barekube install initial-master --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_flags
    # :flag.usage
    printf "  %s\n" "$(magenta "--reinstall")"
    printf "    Reinstall k3s\n"
    echo

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_install_master_node_usage() {
  printf "barekube install master-node - Install and configure another k3s master node\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube install master-node [OPTIONS]\n"
  printf "  barekube install master-node --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_flags
    # :flag.usage
    printf "  %s\n" "$(magenta "--reinstall")"
    printf "    Reinstall k3s\n"
    echo

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_install_agent_node_usage() {
  printf "barekube install agent-node - Install and configure k3s agent node\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube install agent-node [OPTIONS]\n"
  printf "  barekube install agent-node --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_flags
    # :flag.usage
    printf "  %s\n" "$(magenta "--reinstall")"
    printf "    Reinstall k3s\n"
    echo

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_install_gvisor_usage() {
  printf "barekube install gvisor - Install and configure gVisor for existing k3s node\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube install gvisor\n"
  printf "  barekube install gvisor --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_install_longhorn_dependencies_usage() {
  printf "barekube install longhorn-dependencies - Install and configure Longhorn storage dependencies\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube install longhorn-dependencies\n"
  printf "  barekube install longhorn-dependencies --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_k3s_usage() {
  printf "barekube k3s\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube k3s COMMAND\n"
  printf "  barekube k3s [COMMAND] --help | -h\n"
  echo
  # :command.usage_commands
  printf "%s\n" "$(bold "Commands:")"
  printf "  %s   Start k3s master node\n" "$(green "start")      "
  printf "  %s   Stop k3s master node\n" "$(green "stop")       "
  printf "  %s   Uninstall k3s and all related containers\n" "$(green "uninstall")  "
  printf "  %s   Kill k3s and all k3s related containers\n" "$(green "killall")    "
  printf "  %s   Start k3s agent node\n" "$(green "start-agent")"
  printf "  %s   Stop k3s agent node\n" "$(green "stop-agent") "
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

    # :command.usage_examples
    printf "%s\n" "$(bold "Examples:")"
    printf "  barekube install dependencies\n"
    printf "  barekube install initial-master --reinstall\n"
    printf "  barekube install master-node\n"
    printf "  barekube install agent-node --reinstall\n"
    echo

  fi
}

# :command.usage
barekube_k3s_start_usage() {
  printf "barekube k3s start - Start k3s master node\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube k3s start\n"
  printf "  barekube k3s start --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_k3s_stop_usage() {
  printf "barekube k3s stop - Stop k3s master node\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube k3s stop\n"
  printf "  barekube k3s stop --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_k3s_uninstall_usage() {
  printf "barekube k3s uninstall - Uninstall k3s and all related containers\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube k3s uninstall\n"
  printf "  barekube k3s uninstall --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_k3s_killall_usage() {
  printf "barekube k3s killall - Kill k3s and all k3s related containers\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube k3s killall\n"
  printf "  barekube k3s killall --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_k3s_start_agent_usage() {
  printf "barekube k3s start-agent - Start k3s agent node\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube k3s start-agent\n"
  printf "  barekube k3s start-agent --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_k3s_stop_agent_usage() {
  printf "barekube k3s stop-agent - Stop k3s agent node\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube k3s stop-agent\n"
  printf "  barekube k3s stop-agent --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
barekube_upgrade_usage() {
  printf "barekube upgrade - Upgrade barekube CLI to latest version\n\n"

  printf "%s\n" "$(bold "Usage:")"
  printf "  barekube upgrade [OPTIONS]\n"
  printf "  barekube upgrade --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n "$long_usage" ]]; then
    printf "%s\n" "$(bold "Options:")"

    # :command.usage_flags
    # :flag.usage
    printf "  %s\n" "$(magenta "--yes, -y")"
    printf "    Automaticaly upgrades CLI into $HOME/bin directory.\n"
    echo

    # :command.usage_fixed_flags
    printf "  %s\n" "$(magenta "--help, -h")"
    printf "    Show this help\n"
    echo

  fi
}

# :command.normalize_input
# :command.normalize_input_function
normalize_input() {
  local arg passthru flags
  passthru=false

  while [[ $# -gt 0 ]]; do
    arg="$1"
    if [[ $passthru == true ]]; then
      input+=("$arg")
    elif [[ $arg =~ ^(--[a-zA-Z0-9_\-]+)=(.+)$ ]]; then
      input+=("${BASH_REMATCH[1]}")
      input+=("${BASH_REMATCH[2]}")
    elif [[ $arg =~ ^(-[a-zA-Z0-9])=(.+)$ ]]; then
      input+=("${BASH_REMATCH[1]}")
      input+=("${BASH_REMATCH[2]}")
    elif [[ $arg =~ ^-([a-zA-Z0-9][a-zA-Z0-9]+)$ ]]; then
      flags="${BASH_REMATCH[1]}"
      for ((i = 0; i < ${#flags}; i++)); do
        input+=("-${flags:i:1}")
      done
    elif [[ "$arg" == "--" ]]; then
      passthru=true
      input+=("$arg")
    else
      input+=("$arg")
    fi

    shift
  done
}

# :command.inspect_args
inspect_args() {
  if ((${#args[@]})); then
    readarray -t sorted_keys < <(printf '%s\n' "${!args[@]}" | sort)
    echo args:
    for k in "${sorted_keys[@]}"; do
      echo "- \${args[$k]} = ${args[$k]}"
    done
  else
    echo args: none
  fi

  if ((${#deps[@]})); then
    readarray -t sorted_keys < <(printf '%s\n' "${!deps[@]}" | sort)
    echo
    echo deps:
    for k in "${sorted_keys[@]}"; do
      echo "- \${deps[$k]} = ${deps[$k]}"
    done
  fi

  if ((${#env_var_names[@]})); then
    readarray -t sorted_names < <(printf '%s\n' "${env_var_names[@]}" | sort)
    echo
    echo "environment variables:"
    for k in "${sorted_names[@]}"; do
      echo "- \$$k = ${!k:-}"
    done
  fi
}

# :command.user_lib
# ./src/barekube.sh
#!/bin/bash
#!/bin/bash

upgrade_barekube() {
  AUTOMATIC_MODE=$(is_automatic_mode "$1")

  echo_info "Upgrading barekube CLI $(barekube --version)"
  local BAREKUBE_HOME_PATH="$HOME/bin"
  local BAREKUBE_PATH="$BAREKUBE_HOME_PATH"
  if [[ $AUTOMATIC_MODE != "0" ]]
  then
    BAREKUBE_PATH="$(question "Enter the path where workspace is installed ($BAREKUBE_HOME_PATH as default): ")"
    if [ -z "$BAREKUBE_PATH" ]
    then
        BAREKUBE_PATH="$BAREKUBE_HOME_PATH"
    fi
  fi
  echo_message "Upgrading barekube CLI at $BAREKUBE_PATH"
  wget https://raw.githubusercontent.com/kostiantyn-matsebora/barekube/master/release/barekube -O "$BAREKUBE_PATH/barekube"
  chmod +x "$BAREKUBE_PATH/barekube"
  exit_if_error "Error upgrading barekube"
  echo_info "Barekube CLI is upgraded successfully to version $(barekube --version)"
}

# ./src/k3s.sh
#!/bin/bash

update_packages() {
    echo_message "Updating packages..."
    sudo apt update

    exit_if_error "Failed to update packages"
}

install_containerd() {
    echo_message "Installing containerd..."
    sudo apt install -y containerd
    exit_if_error "Failed to install containerd"
}

install_gvisor() {
     echo_message "Installing gVisor dependencies..."
     sudo apt install -y \
        apt-transport-https \
        ca-certificates \
        curl \
        gnupg

    echo_message "Adding gVisor key..."
    curl -fsSL https://gvisor.dev/archive.key | sudo gpg --dearmor -o /usr/share/keyrings/gvisor-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/gvisor-archive-keyring.gpg] https://storage.googleapis.com/gvisor/releases release main" | sudo tee /etc/apt/sources.list.d/gvisor.list > /dev/null

    exit_if_error "Failed to add gVisor key"

    echo_message "Installing gVisor..."
    sudo apt-get update && sudo apt-get install -y runsc

    exit_if_error "Failed to install gVisor"
}

register_gvisor_to_k3s() {
    echo_message "Checking containerd configuration..."
    grep -q ".containerd.runtimes.runsc" /var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl

    if [ $? -ne "0" ]
    then
    echo_message "Copying containerd config to template..."
    cp /var/lib/rancher/k3s/agent/etc/containerd/config.toml /var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl

    echo_info "Adding runsc runtime to containerd configuration..."
sudo tee -a /var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl <<EOF
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runsc]
  runtime_type = "io.containerd.runsc.v1"
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runsc.options]
  TypeUrl = "io.containerd.runsc.v1.options"
  ConfigPath = "/etc/containerd/runsc.toml"
EOF
    exit_if_error "Failed to add runsc runtime to containerd configuration"

    echo_message "Restarting k3s..."
    sudo systemctl restart k3s
    exit_if_error "Failed to register gVisor to k3s"
    fi
    return 0
}

install_wireguard() {
    echo_message "Installing wireguard..."
    sudo apt install -y wireguard
    exit_if_error  "Failed to install wireguard"
}

check_k3s_installed() {
    echo_message "Checking if k3s is already installed..."
    check_if_command_exists "k3s"
     # shellcheck disable=SC2181
     if [[ $? -eq 0 ]]
     then
         echo_info "k3s is already installed."
         if [[ "$1" -ne "1" ]]
         then
             exit 0
         fi
     fi
}

gather_additional_args() {
    local ADDITIONAL_ARGS=""
    yes_or_no "Do you want to set additional parameters?"
    # shellcheck disable=SC2181
    if [[ $? -ne 0 ]]
    then
        return 0
    fi

    yes_or_no "Do you want to disable load balancer"
    # shellcheck disable=SC2181
    if [[ $? -eq 0 ]]
    then
        ADDITIONAL_ARGS="$ADDITIONAL_ARGS --disable=servicelb"
    fi
    yes_or_no "Do you want to disable traefik"
    # shellcheck disable=SC2181
    if [[ $? -eq 0 ]]
    then
        ADDITIONAL_ARGS="$ADDITIONAL_ARGS --disable=traefik"
    fi
    yes_or_no "Do you want to set TLS SAN?"
    # shellcheck disable=SC2181
    if [[ $? -eq 0 ]]
    then
        local SAN
        SAN=$(read_input  "Enter the SAN:")
        ADDITIONAL_ARGS="$ADDITIONAL_ARGS --tls-san $SAN"
    fi
    yes_or_no "Do you want to add another additional arguments?"
    if [[ $? -eq 0 ]]
    then
        ADDITIONAL_ARGS="$ADDITIONAL_ARGS $(read_input  "Enter the additional arguments:")"
    fi
    echo "$ADDITIONAL_ARGS"
}

gather_master_params() {
    local MASTER_PARAMS
    local MASTER_URL
    MASTER_URL=$(read_input "Enter the master URL(e.g. https://192.168.1.1:6443):")
    if [[ -z "$MASTER_URL" ]]
    then
        echo_error "Master URL is required."
        exit 1
    fi

    MASTER_PARAMS="$MASTER_PARAMS --server=$MASTER_URL"
    TOKEN=$(read_input  "Enter the token:")
    if [[ -z "$TOKEN" ]]
    then
        echo_error "Token is required."
        exit 1
    fi
    MASTER_PARAMS="$MASTER_PARAMS --token=$TOKEN"
    echo "$MASTER_PARAMS"
}

install_k3s_initial_master() {
    echo_message "Installing initial k3s master node..."
    local COMMAND
    COMMAND="curl -sfL https://get.k3s.io | sh -s - server  --cluster-init --flannel-backend wireguard-native $2"
    echo_message "Running command: $COMMAND"
    eval "$COMMAND"
    exit_if_error "Failed to install k3s"
    return 0
}

show_k3s_token() {
    echo_message "Getting token..."
    local K3S_TOKEN
    K3S_TOKEN=$(sudo cat /var/lib/rancher/k3s/server/token)
    echo_message "K3S_TOKEN: $(magenta """$K3S_TOKEN""")"
    echo_message "Use it for joining agents and other master nodes to the cluster."
}

install_k3s_master() {
    echo_message "Installing k3s master node..."
    local COMMAND
    # shellcheck disable=SC2027
    COMMAND="curl -sfL https://get.k3s.io | sh -s - server """$1""" --flannel-backend wireguard-native """$2""""
    echo_message "Running command: $COMMAND"
    eval "$COMMAND"
    exit_if_error "Failed to install k3s"
    return 0
}

install_k3s_agent() {
    echo_message "Installing k3s agent node..."
    local COMMAND
    # shellcheck disable=SC2027
    COMMAND="curl -sfL https://get.k3s.io | sh -s - agent """$1""" --flannel-backend wireguard-native """$2""""
    echo_message "Running command: $COMMAND"
    eval "$COMMAND"
    exit_if_error "Failed to install k3s"
    return 0
}

start_k3s_master() {
    echo_message "Starting k3s..."
    sudo systemctl start k3s
    exit_if_error "Failed to start k3s"
}

stop_k3s_master() {
    echo_message "Stopping k3s..."
    sudo systemctl stop k3s
    exit_if_error "Failed to stop k3s"
}

start_k3s_agent() {
    echo_message "Starting k3s agent..."
    sudo systemctl start k3s-agent
    exit_if_error "Failed to start k3s agent"
}

stop_k3s_agent() {
    echo_message "Stopping k3s agent..."
    sudo systemctl stop k3s-agent
    exit_if_error "Failed to stop k3s agent"
}

killall_k3s() {
    echo_message "Killing k3s..."
    sudo /usr/local/bin/k3s-killall.sh
    exit_if_error "Failed to kill k3s"
}

uninstall_k3s() {
    yes_or_no "Do you want to uninstall k3s?"
    if [[ $? -eq 0 ]]
    then
        echo_message "Uninstalling k3s..."
        sudo /usr/local/bin/k3s-uninstall.sh
        exit_if_error "Failed to uninstall k3s"
    fi
}

# ./src/longhorn.sh
#!/bin/bash
install_longhorn_dependencies() {
    echo_message "Updating packages..." && sudo apt update
    echo_message "Installing open-iscsi..." && sudo apt install -y open-iscsi
    echo_message "Installing bash..." && sudo apt install -y bash
    echo_message "Installing curl..." && sudo apt install -y curl
    echo_message "Installing grep..." && sudo apt install -y grep
    echo_message "Installing nfs-common..." && sudo apt install -y nfs-common
    return 0
}

# ./src/shared/colors.sh
print_in_color() {
  local color="$1"
  shift
  if [[ -z ${NO_COLOR+x} ]]; then
    printf "$color%b\e[0m\n" "$*"
  else
    printf "%b\n" "$*"
  fi
}

red() { print_in_color "\e[31m" "$*"; }
green() { print_in_color "\e[32m" "$*"; }
yellow() { print_in_color "\e[33m" "$*"; }
blue() { print_in_color "\e[34m" "$*"; }
magenta() { print_in_color "\e[35m" "$*"; }
cyan() { print_in_color "\e[36m" "$*"; }
bold() { print_in_color "\e[1m" "$*"; }
underlined() { print_in_color "\e[4m" "$*"; }
red_bold() { print_in_color "\e[1;31m" "$*"; }
green_bold() { print_in_color "\e[1;32m" "$*"; }
yellow_bold() { print_in_color "\e[1;33m" "$*"; }
blue_bold() { print_in_color "\e[1;34m" "$*"; }
magenta_bold() { print_in_color "\e[1;35m" "$*"; }
cyan_bold() { print_in_color "\e[1;36m" "$*"; }
red_underlined() { print_in_color "\e[4;31m" "$*"; }
green_underlined() { print_in_color "\e[4;32m" "$*"; }
yellow_underlined() { print_in_color "\e[4;33m" "$*"; }
blue_underlined() { print_in_color "\e[4;34m" "$*"; }
magenta_underlined() { print_in_color "\e[4;35m" "$*"; }
cyan_underlined() { print_in_color "\e[4;36m" "$*"; }

# ./src/shared/shared.sh
#!/bin/bash

timestamp() {
  date +%F_%T # current date and time
}

green() {
    echo -e "\033[0;32m$1\033[0m"
}

yellow_bold() {
    echo -e "\033[1;33m$1\033[0m"
}

red() {
    echo -e "\033[0;31m$1\033[0m"
}

green_bold() {
    echo -e "\033[1;92m$1\033[0m"
}

magenta() {
    echo -e "\033[0;35m$1\033[0m"
}

echo_message(){
    echo -e "$(green "[$(timestamp)] $1\n")"
}

echo_info(){
    echo -e "$(yellow_bold "[$(timestamp)] $1\n")"

}

echo_important(){
    echo -e "$(magenta "[$(timestamp)] $1\n")"

}

echo_error(){
    echo -e "$(red "[$(timestamp)] $1\n")"
}

function question(){
    local MESSAGE
    MESSAGE=$(green_bold "[$(timestamp)] $1\n")

    read -sn 1 -r -p "$MESSAGE" ANSWER
    # shellcheck disable=SC2028
    echo  "${ANSWER//[$'\t\r\n ']}"
}

function read_input(){
    local MESSAGE
    MESSAGE=$(green_bold "[$(timestamp)] $1\n")

    read -r -p "$MESSAGE" ANSWER
    # shellcheck disable=SC2028
    echo  "${ANSWER//[$'\t\r\n ']}"
}

function exit_if_error(){
    if [ "$?" -ne "0" ]
    then
        echo_error "$1"
        exit $?
    fi
}

function echo_final(){
    if [ "$?" -ne "0" ]
    then
        echo_error "$1"
        exit $?
    else

        echo_info "$2"
    fi
}

function yes_or_no(){
    if [[ "$2" == "0" ]]
    then
        return 0
    fi

    local ANSWER
    ANSWER=$(question "$1 [y/n]")
    if [[ "$ANSWER" = "y" || "$ANSWER" = "Y" ]]
    then
        return 0
    else
        return 1
    fi
}

function exit_if_answer_no() {
    if [[ $? -ne 0 ]]
    then
        echo_message "Exiting..."
        exit 0
    fi
}

function is_automatic_mode(){
    if [[ "$1" == "--yes" || "$1" == "-y" ]]
    then
        echo 0
    else
        echo 1
    fi
}

function press_any_key(){
    read -n 1 -s -r -p "Press any key to continue..."
}

function check_if_command_exists(){
    command -v "$1" &> /dev/null
    if [ $? -ne 0 ]
    then
        return 1
    else
        return 0
    fi
}

# :command.command_functions

# :command.function
barekube_install_dependencies_command() {

  # ./commands/install/dependencies.sh
  echo "# This file is located at './commands/install/dependencies.sh'."
  echo "# It contains the implementation for the 'barekube install dependencies' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_install_dependencies_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args
  echo_info "Installing dependencies..."
  update_packages
  install_wireguard
  echo_final "Failed to install dependencies." "Dependencies are installed succcessfully."

}

# :command.function
barekube_install_initial_master_command() {

  # ./commands/install/initial-master.sh
  echo "# This file is located at './commands/install/kubernetes/initial-master.sh'."
  echo "# It contains the implementation for the 'barekube install kubernetes initial-master' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_install_kubernetes_initial_master_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args
  # shellcheck disable=SC2154
  check_k3s_installed "${args[--reinstall]}"
  echo_info "Installing initial k3s master node..."
  ADDITIONAL_ARGS=$(gather_additional_args)

  install_k3s_initial_master "${ADDITIONAL_ARGS}"
  install_gvisor
  register_gvisor_to_k3s
  show_k3s_token
  echo_final "Failed to install initial k3s master node." "Initial k3s master node installed successfully."

}

# :command.function
barekube_install_master_node_command() {

  # ./commands/install/master-node.sh
  echo "# This file is located at './commands/install/master.sh'."
  echo "# It contains the implementation for the 'barekube install master' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_install_master_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args
  # shellcheck disable=SC2154
  check_k3s_installed "${args[--reinstall]}"
  MASTER_PARAMS=$(gather_master_params)
  ADDITIONAL_ARGS=$(gather_additional_args)
  echo_info "Installing master node..."

  echo_info "Master parameters: $MASTER_PARAMS"
  echo_info "Additional arguments: $ADDITIONAL_ARGS"

  install_k3s_master "$MASTER_PARAMS" "$ADDITIONAL_ARGS"
  install_gvisor
  register_gvisor_to_k3s
  echo_final "Failed to install k3s master node." "Another k3s master node installed successfully."

}

# :command.function
barekube_install_agent_node_command() {

  # ./commands/install/agent-node.sh
  echo "# This file is located at './commands/install/master.sh'."
  echo "# It contains the implementation for the 'barekube install master' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_install_master_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args
  # shellcheck disable=SC2154
  check_k3s_installed "${args[--reinstall]}"
  MASTER_PARAMS=$(gather_master_params)
  ADDITIONAL_ARGS=$(gather_additional_args)
  echo_info "Installing agent node..."

  install_k3s_agent "$MASTER_PARAMS" "$ADDITIONAL_ARGS"
  install_gvisor
  register_gvisor_to_k3s
  echo_final "Failed to install k3s agent node." "Another k3s agent node installed successfully."

}

# :command.function
barekube_install_gvisor_command() {

  # ./commands/install/gvisor.sh
  echo "# This file is located at './commands/install/gvisor.sh'."
  echo "# It contains the implementation for the 'barekube install gvisor' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_install_gvisor_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args
  install_gvisor
  register_gvisor_to_k3s

}

# :command.function
barekube_install_longhorn_dependencies_command() {

  # ./commands/install/longhorn-dependencies.sh
  echo "# This file is located at './commands/longhorn/install-dependencies.sh'."
  echo "# It contains the implementation for the 'barekube longhorn install-dependencies' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_longhorn_install_dependencies_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args

  echo_info "Installing longhorn dependencies..."
  install_longhorn_dependencies

  echo_final "Failed to install longhorn dependencies." "Longhorn dependencies are installed succcessfully."
  echo_info "To fix multipath issue, please follow instructions: $(magenta """https://longhorn.io/kb/troubleshooting-volume-with-multipath/""")"

}

# :command.function
barekube_k3s_start_command() {

  # ./commands/k3s/start.sh
  echo "# This file is located at './commands/k3s/start.sh'."
  echo "# It contains the implementation for the 'barekube k3s start' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_k3s_start_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args
  start_k3s_master

}

# :command.function
barekube_k3s_stop_command() {

  # ./commands/k3s/stop.sh
  echo "# This file is located at './commands/k3s/stop.sh'."
  echo "# It contains the implementation for the 'barekube k3s stop' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_k3s_stop_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args
  stop_k3s_master

}

# :command.function
barekube_k3s_uninstall_command() {

  # ./commands/k3s/uninstall.sh
  echo "# This file is located at './commands/k3s/uninstall.sh'."
  echo "# It contains the implementation for the 'barekube k3s uninstall' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_k3s_uninstall_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args
  uninstall_k3s

}

# :command.function
barekube_k3s_killall_command() {

  # ./commands/k3s/killall.sh
  echo "# This file is located at './commands/k3s/killall.sh'."
  echo "# It contains the implementation for the 'barekube k3s killall' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_k3s_killall_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args
  killall_k3s

}

# :command.function
barekube_k3s_start_agent_command() {

  # ./commands/k3s/start-agent.sh
  echo "# This file is located at './commands/k3s/start-agent.sh'."
  echo "# It contains the implementation for the 'barekube k3s start-agent' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_k3s_start_agent_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args
  start_k3s_agent

}

# :command.function
barekube_k3s_stop_agent_command() {

  # ./commands/k3s/stop-agent.sh
  echo "# This file is located at './commands/k3s/stop-agent.sh'."
  echo "# It contains the implementation for the 'barekube k3s stop-agent' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_k3s_stop_agent_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args
  stop_k3s_agent

}

# :command.function
barekube_upgrade_command() {

  # ./commands/upgrade.sh
  echo "# This file is located at './commands/upgrade.sh'."
  echo "# It contains the implementation for the 'barekube upgrade' command."
  echo "# The code you write here will be wrapped by a function named 'barekube_upgrade_command()'."
  echo "# Feel free to edit this file; your changes will persist when regenerating."
  inspect_args
  upgrade_barekube

}

# :command.parse_requirements
parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --version | -v)
        version_command
        exit
        ;;

      --help | -h)
        long_usage=yes
        barekube_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action=${1:-}

  case $action in
    -*) ;;

    install)
      action="install"
      shift
      barekube_install_parse_requirements "$@"
      shift $#
      ;;

    k3s)
      action="k3s"
      shift
      barekube_k3s_parse_requirements "$@"
      shift $#
      ;;

    upgrade)
      action="upgrade"
      shift
      barekube_upgrade_parse_requirements "$@"
      shift $#
      ;;

    # :command.command_fallback
    "")
      barekube_usage >&2
      exit 1
      ;;

    *)
      if [[ -x "$(command -v "barekube-$action")" ]]; then
        shift
        exec "barekube-$action" "$@"
      else
        printf "invalid command: %s\n" "$action" >&2
        exit 1
      fi
      ;;

  esac

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_install_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_install_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action=${1:-}

  case $action in
    -*) ;;

    dependencies)
      action="dependencies"
      shift
      barekube_install_dependencies_parse_requirements "$@"
      shift $#
      ;;

    initial-master)
      action="initial-master"
      shift
      barekube_install_initial_master_parse_requirements "$@"
      shift $#
      ;;

    master-node)
      action="master-node"
      shift
      barekube_install_master_node_parse_requirements "$@"
      shift $#
      ;;

    agent-node)
      action="agent-node"
      shift
      barekube_install_agent_node_parse_requirements "$@"
      shift $#
      ;;

    gvisor)
      action="gvisor"
      shift
      barekube_install_gvisor_parse_requirements "$@"
      shift $#
      ;;

    longhorn-dependencies)
      action="longhorn-dependencies"
      shift
      barekube_install_longhorn_dependencies_parse_requirements "$@"
      shift $#
      ;;

    # :command.command_fallback
    "")
      barekube_install_usage >&2
      exit 1
      ;;

    *)
      printf "invalid command: %s\n" "$action" >&2
      exit 1
      ;;

  esac

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_install_dependencies_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_install_dependencies_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="install dependencies"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_install_initial_master_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_install_initial_master_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="install initial-master"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      # :flag.case
      --reinstall)

        # :flag.case_no_arg
        args['--reinstall']=1
        shift
        ;;

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_install_master_node_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_install_master_node_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="install master-node"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      # :flag.case
      --reinstall)

        # :flag.case_no_arg
        args['--reinstall']=1
        shift
        ;;

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_install_agent_node_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_install_agent_node_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="install agent-node"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      # :flag.case
      --reinstall)

        # :flag.case_no_arg
        args['--reinstall']=1
        shift
        ;;

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_install_gvisor_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_install_gvisor_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="install gvisor"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_install_longhorn_dependencies_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_install_longhorn_dependencies_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="install longhorn-dependencies"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_k3s_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_k3s_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action=${1:-}

  case $action in
    -*) ;;

    start)
      action="start"
      shift
      barekube_k3s_start_parse_requirements "$@"
      shift $#
      ;;

    stop)
      action="stop"
      shift
      barekube_k3s_stop_parse_requirements "$@"
      shift $#
      ;;

    uninstall)
      action="uninstall"
      shift
      barekube_k3s_uninstall_parse_requirements "$@"
      shift $#
      ;;

    killall)
      action="killall"
      shift
      barekube_k3s_killall_parse_requirements "$@"
      shift $#
      ;;

    start-agent)
      action="start-agent"
      shift
      barekube_k3s_start_agent_parse_requirements "$@"
      shift $#
      ;;

    stop-agent)
      action="stop-agent"
      shift
      barekube_k3s_stop_agent_parse_requirements "$@"
      shift $#
      ;;

    # :command.command_fallback
    "")
      barekube_k3s_usage >&2
      exit 1
      ;;

    *)
      printf "invalid command: %s\n" "$action" >&2
      exit 1
      ;;

  esac

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_k3s_start_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_k3s_start_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="k3s start"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_k3s_stop_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_k3s_stop_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="k3s stop"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_k3s_uninstall_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_k3s_uninstall_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="k3s uninstall"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_k3s_killall_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_k3s_killall_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="k3s killall"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_k3s_start_agent_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_k3s_start_agent_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="k3s start-agent"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_k3s_stop_agent_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_k3s_stop_agent_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="k3s stop-agent"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
barekube_upgrade_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      --help | -h)
        long_usage=yes
        barekube_upgrade_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.dependencies_filter
  missing_deps=
  # :dependency.filter
  if ! command -v wget >/dev/null 2>&1; then
    printf "missing dependency: wget\n" >&2
    missing_deps=1
  else
    deps['wget']="$(command -v wget | head -n1)"
  fi

  if [[ -n $missing_deps ]]; then
    exit 1
  fi

  # :command.command_filter
  action="upgrade"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in
      # :flag.case
      --yes | -y)

        # :flag.case_no_arg
        args['--yes']=1
        shift
        ;;

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.initialize
initialize() {
  declare -g version="0.1.0"

}

# :command.run
run() {
  # :command.globals
  declare -g long_usage=''
  declare -g -A args=()
  declare -g -A deps=()
  declare -g -a env_var_names=()
  declare -g -a input=()

  normalize_input "$@"
  parse_requirements "${input[@]}"

  case "$action" in
    "install") barekube_install_command ;;
    "install dependencies") barekube_install_dependencies_command ;;
    "install initial-master") barekube_install_initial_master_command ;;
    "install master-node") barekube_install_master_node_command ;;
    "install agent-node") barekube_install_agent_node_command ;;
    "install gvisor") barekube_install_gvisor_command ;;
    "install longhorn-dependencies") barekube_install_longhorn_dependencies_command ;;
    "k3s") barekube_k3s_command ;;
    "k3s start") barekube_k3s_start_command ;;
    "k3s stop") barekube_k3s_stop_command ;;
    "k3s uninstall") barekube_k3s_uninstall_command ;;
    "k3s killall") barekube_k3s_killall_command ;;
    "k3s start-agent") barekube_k3s_start_agent_command ;;
    "k3s stop-agent") barekube_k3s_stop_agent_command ;;
    "upgrade") barekube_upgrade_command ;;
  esac
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  initialize
  run "$@"
fi
